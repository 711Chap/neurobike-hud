<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>NeuroBike</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* GPS marker pulse and proximity dot */
    .gps-marker-icon .gps-ring {
      border: 3px solid #22d3ee;
      border-radius: 50%;
      height: 24px; width: 24px;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 15px #22d3ee;
      animation: pulse-ring 1.5s infinite;
    }
    @keyframes pulse-ring {
      0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.8; }
      70% { transform: translate(-50%, -50%) scale(1.8); opacity: 0; }
      100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
    }
    .prox-dot { height: 14px; width: 14px; border-radius: 9999px; display:inline-block;box-shadow:0 0 10px rgba(0,0,0,0.08);vertical-align:middle;margin-right:8px;transition: transform .18s, box-shadow .18s, background-color .18s;}
    .prox-green { background-color: #16a34a; box-shadow: 0 0 10px rgba(22,163,74,0.35); }
    .prox-yellow { background-color: #f59e0b; box-shadow: 0 0 10px rgba(245,158,11,0.35); }
    .prox-red { background-color: #dc2626; box-shadow: 0 0 12px rgba(220,38,38,0.45); transform: scale(1.2); }
    .prox-pulse { animation: proxPulse 1s infinite ease-in-out; }
    @keyframes proxPulse { 0%{transform:scale(1);opacity:1;}50%{transform:scale(1.35);opacity:.85;}100%{transform:scale(1);opacity:1;} }
    #emergencyOverlay {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background-color: rgba(255,0,0,0.85); z-index: 2000;
      display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; text-align:center;
      animation: flashRed 0.5s infinite alternate;
    }
    @keyframes flashRed {
      from { background-color: rgba(255,0,0,0.85);} to { background-color: rgba(255,0,0,0.65);} }

    /* Responsive layout tweaks */
    body { margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; background: linear-gradient(135deg, #e6f7ff 0%, #f0f9ff 50%, #eef2ff 100%); color:#0f172a; height:100vh; overflow:hidden; }

    .app-grid { display:grid; grid-template-columns: 1fr; grid-template-rows: 1fr; height:100vh; }

    /* Map prioritized on top for mobile, stats below. Reduced map height so bottom stats are fully visible without scrolling */
    #map { width:100%; height: 54vh; border-radius:12px; box-shadow: 0 8px 30px rgba(2,6,23,0.08); border:1px solid rgba(15,23,42,0.04); }

    .bottom-stats { height: calc(100vh - 54vh - 20px); overflow:auto; padding:10px; box-sizing:border-box; }
    .card { background: rgba(255,255,255,0.94); backdrop-filter: blur(6px); border-radius:12px; padding:12px; margin-bottom:10px; box-shadow: 0 10px 24px rgba(2,6,23,0.06); border:1px solid rgba(255,255,255,0.6); }

    .speed-value { font-weight:900; font-size: clamp(28px, 8vw, 56px); line-height:1; }
    .label { font-size:12px; color:#475569; font-weight:700; letter-spacing:0.5px; }

    /* Floating connect controls */
    .top-controls { position: absolute; top: 10px; right: 10px; z-index:1200; display:flex; gap:8px; align-items:center; }
    .btn { border-radius:10px; padding:8px 12px; font-weight:700; border:none; cursor:pointer; box-shadow:0 8px 18px rgba(2,6,23,0.06); }
    .btn-connect { background:#059669; color:white; } /* green */
    .btn-disconnect { background:#dc2626; color:white; } /* red */
    .status { padding:8px 12px; border-radius:10px; background: rgba(255,255,255,0.9); color:#0f172a; font-weight:700; box-shadow:0 8px 18px rgba(2,6,23,0.06); }

    /* HUD proximity + calories overlay (calories has no dot) */
    .hud-overlays { position:absolute; right:14px; top:78px; z-index:1005; pointer-events:none; display:flex; flex-direction:column; gap:10px; }
    .hud { pointer-events:auto; display:flex; gap:10px; align-items:center; padding:8px 10px; background: rgba(255,255,255,0.95); backdrop-filter: blur(6px); border-radius:10px; box-shadow:0 10px 24px rgba(2,6,23,0.08); border:1px solid rgba(0,0,0,0.04); font-weight:800; }
    .hud .small { font-size:12px; color:#475569; }
    .hud .value { font-size:15px; }

    @media(min-width:900px){
      /* Desktop: map on right, stats left */
      .desktop-grid { display:grid; grid-template-columns: 40% 60%; gap:18px; height:100vh; padding:18px; box-sizing:border-box; }
      #map { height: calc(100vh - 36px); border-radius:14px; }
      .hud-overlays { top: 110px; right: 40px; }
      .bottom-stats { height:auto; overflow:visible; padding:0; }
    }
  </style>
</head>
<body>
  <div class="app-grid">

    <div id="map"></div>

    <!-- Floating proximity + calories overlays (calories has no dot indicator) -->
    <div class="hud-overlays" aria-hidden="false">
      <div id="proximityOverlay" class="hud" role="status" aria-label="proximity">
        <div id="proxDotSmall" class="prox-dot prox-green" aria-hidden="true"></div>
        <div>
          <div class="small">Proximity</div>
          <div id="overlayProxValue" class="value">-- cm</div>
        </div>
      </div>

      <div id="calorieOverlay" class="hud" role="status" aria-label="calories">
        <div style="width:14px; height:14px;" aria-hidden="true"></div>
        <div>
          <div class="small">Calories</div>
          <div id="overlayCaloriesValue" class="value">-- kcal</div>
        </div>
      </div>
    </div>

    <!-- Top-right connect controls -->
    <div class="top-controls">
      <button id="connectButton" class="btn btn-connect">Connect</button>
      <button id="disconnectButton" class="btn btn-disconnect" disabled>Disconnect</button>
      <div id="connectionStatus" class="status">Disconnected</div>
    </div>

    <!-- Stats area below map (mobile). On desktop you can restyle to left by CSS media query. -->
    <div class="bottom-stats">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>
            <div class="label">SPEED</div>
            <div style="display:flex; align-items:baseline; gap:8px;">
              <div id="speedValue" class="speed-value">--</div>
              <div style="font-weight:700; color:#475569;">km/h</div>
            </div>
          </div>
          <div style="text-align:right; min-width:120px;">
            <div class="label">Crash</div>
            <div id="crashStatus" style="font-weight:900; font-size:18px; color:#16a34a;">SAFE</div>
            <div style="height:8px"></div>
            <div class="label">Terrain</div>
            <div id="terrainStatus" style="font-weight:900; font-size:18px; color:#16a34a;">SMOOTH</div>
          </div>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:12px;">
          <div>
            <div class="label">Duration</div>
            <div id="summaryDuration" style="font-weight:900; font-size:16px;">--:--:--</div>
          </div>
          <div style="display:flex; gap:8px;">
            <button id="timerStart" class="btn" title="Start">▶</button>
            <button id="timerStop" class="btn" title="Stop">■</button>
            <button id="timerReset" class="btn" title="Reset">↺</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div style="display:flex; gap:12px;">
          <div style="flex:1; text-align:center;">
            <div class="label">Distance</div>
            <div id="summaryDistance" style="font-weight:800;">-- km</div>
          </div>
          <div style="flex:1; text-align:center;">
            <div class="label">Avg Speed</div>
            <div id="summaryAvgSpeed" style="font-weight:800;">-- km/h</div>
          </div>
          <div style="flex:1; text-align:center;">
            <div class="label">Max Speed</div>
            <div id="summaryMaxSpeed" style="font-weight:800;">-- km/h</div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Keep existing JS logic. Below is the minimal init to show map and wire UI elements.
    function initMap(){
      try{
        const map = L.map('map', { zoomControl:false, attributionControl:false }).setView([51.505, -0.09], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'© OpenStreetMap contributors'}).addTo(map);
        const pulsingIcon = L.divIcon({className:'gps-marker-icon', html:'<div class="gps-ring"></div>', iconSize:[24,24], iconAnchor:[12,12]});
        const marker = L.marker([51.505, -0.09], { icon: pulsingIcon }).addTo(map);
        window._neuro_map = map; window._neuro_marker = marker;
      }catch(e){ console.error('Map init failed', e); }
    }
    window.addEventListener('DOMContentLoaded', ()=>{ initMap(); /* other JS (BLE, parsing, session) should be attached here from your main script */
      // ensure calorie overlay mirrors initial state same as proximity
      document.getElementById('overlayCaloriesValue').textContent = '-- kcal';
    });
  </script>
</body>
</html>
