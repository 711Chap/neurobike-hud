<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>SmartCycle HUD</title>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    /*
      The leaflet-tile-pane filter has been REMOVED for the light theme.
      This block only contains the GPS marker pulse.
    */

    /* Custom pulsing icon for the GPS marker */
    .gps-marker-icon .gps-ring {
      border: 3px solid #22d3ee; /* cyan-400 */
      border-radius: 50%;
      height: 24px;
      width: 24px;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 15px #22d3ee;
      animation: pulse-ring 1.5s infinite;
    }

    @keyframes pulse-ring {
      0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.8; }
      70% { transform: translate(-50%, -50%) scale(1.8); opacity: 0; }
      100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
    }

    /* Styles for the full-screen emergency overlay */
    #emergencyOverlay {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background-color: rgba(255, 0, 0, 0.85); z-index: 2000; display: flex;
      flex-direction: column; justify-content: center; align-items: center; color: white; text-align:center;
      animation: flashRed 0.5s infinite alternate;
    }
    @keyframes flashRed { from { background-color: rgba(255,0,0,0.85);} to { background-color: rgba(255,0,0,0.65);} }

    /* Proximity small indicator dot */
    .prox-dot { height: 14px; width: 14px; border-radius: 9999px; display:inline-block; box-shadow:0 0 10px rgba(0,0,0,0.08); vertical-align: middle; margin-right:8px; transition: transform .18s ease, box-shadow .18s ease, background-color .18s ease; }
    .prox-green { background-color: #16a34a; box-shadow: 0 0 10px rgba(22,163,74,0.35); }
    .prox-yellow { background-color: #f59e0b; box-shadow: 0 0 10px rgba(245,158,11,0.35); }
    .prox-red { background-color: #dc2626; box-shadow: 0 0 12px rgba(220,38,38,0.45); transform: scale(1.2); }
    .prox-pulse { animation: proxPulse 1s infinite ease-in-out; }
    @keyframes proxPulse { 0%{transform:scale(1);opacity:1;}50%{transform:scale(1.35);opacity:.85;}100%{transform:scale(1);opacity:1;} }

    /* overlay container */
    .hud-overlays { position: absolute; bottom: 1rem; right: 1rem; display:flex; gap:0.75rem; z-index:1001; }

    /* icon button styles for timer */
    .icon-btn { display:inline-flex; align-items:center; justify-content:center; height:36px; width:36px; border-radius:8px; background:white; box-shadow:0 2px 6px rgba(0,0,0,0.08); }

  </style>
</head>
<body class="bg-gradient-to-br from-blue-100 via-gray-100 to-blue-200 text-gray-900 h-screen w-screen overflow-hidden font-sans flex flex-col transition-colors duration-200 ease-in-out">

  <div class="flex-1 grid grid-cols-1 md:grid-cols-5 overflow-hidden relative">

    <!-- HUD overlays container (calories + proximity) -->
    <div class="hud-overlays">
      <div id="calorieOverlay" class="bg-white/70 backdrop-blur-md shadow-xl border border-white/80 rounded-xl p-3 flex items-center space-x-3 transition-opacity duration-300">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-red-600" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />
        </svg>
        <div>
          <span class="text-xs font-medium text-gray-600 uppercase">Calories</span>
          <p class="text-xl font-bold text-gray-900 leading-none">
            <span id="overlayCaloriesValue">--</span>
            <span class="text-sm font-semibold text-red-600 ml-1">kcal</span>
          </p>
        </div>
      </div>

      <div id="proximityOverlay" class="bg-white/70 backdrop-blur-md shadow-xl border border-white/80 rounded-xl p-3 flex items-center space-x-3 transition-opacity duration-300">
        <div id="proxDotSmall" class="prox-dot prox-green"></div>
        <div>
          <span class="text-xs font-medium text-gray-600 uppercase">Proximity</span>
          <p class="text-xl font-bold text-gray-900 leading-none"><span id="overlayProxValue">--</span> <span class="text-sm">cm</span></p>
        </div>
      </div>
    </div>

    <div class="md:col-span-2 flex flex-col p-4 md:p-6 lg:p-8 space-y-4 lg:space-y-6">

      <div class="flex justify-center items-center py-2 bg-white/30 backdrop-blur-lg shadow-lg border border-white/40 rounded-2xl">
        <h1 class="text-3xl font-bold text-gray-800 my-2">NeuroBike</h1>
      </div>

      <div class="flex-1 flex flex-col justify-center bg-white/30 backdrop-blur-lg shadow-lg border border-white/40 rounded-2xl p-6">
        <h2 class="text-2xl md:text-3xl font-bold text-blue-600 tracking-widest">SPEED</h2>
        <div class="flex items-baseline">
          <span id="speedValue" class="text-7xl md:text-8xl lg:text-9xl font-black text-black" style="line-height: 1;">--</span>
          <span class="text-2xl md:text-3xl font-semibold text-gray-600 ml-2">km/h</span>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 lg:gap-6">
        <div id="crashPanel" class="bg-white/30 backdrop-blur-lg rounded-2xl p-4 text-center transition-all duration-300 shadow-md border-2 border-green-500/30 bg-green-500/10">
          <h3 class="text-sm md:text-base font-semibold text-gray-700 uppercase tracking-wider">Crash Status</h3>
          <div id="crashStatus" class="text-xl md:text-3xl font-bold text-black mt-1">SAFE</div>
        </div>
        <div id="terrainPanel" class="bg-white/30 backdrop-blur-lg rounded-2xl p-4 text-center transition-all duration-300 shadow-md border-2 border-green-500/30 bg-green-500/10">
          <h3 class="text-sm md:text-base font-semibold text-gray-700 uppercase tracking-wider">Terrain</h3>
          <div id="terrainStatus" class="text-xl md:text-3xl font-bold text-black mt-1">SMOOTH</div>
        </div>
      </div>

      <div class="bg-white/30 backdrop-blur-lg shadow-lg border border-white/40 rounded-2xl p-4 lg:p-6 space-y-3">
        <div class="flex items-center justify-between">
          <div>
            <span class="font-medium text-gray-600">Duration</span>
            <div class="flex items-center mt-1">
              <span id="summaryDuration" class="font-semibold text-gray-900 text-2xl">--:--:--</span>
              <!-- Icon buttons next to duration -->
              <div class="ml-3 flex items-center gap-2">
                <button id="timerStart" title="Start" class="icon-btn" aria-label="start">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-600" viewBox="0 0 24 24" fill="currentColor"><path d="M5 3v18l15-9L5 3z"/></svg>
                </button>
                <button id="timerStop" title="Stop" class="icon-btn" aria-label="stop">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-yellow-500" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h12v12H6z"/></svg>
                </button>
                <button id="timerReset" title="Reset" class="icon-btn" aria-label="reset">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500" viewBox="0 0 24 24" fill="currentColor"><path d="M12 6V3L8 7l4 4V8c2.8 0 5 2.2 5 5 0 2.8-2.2 5-5 5s-5-2.2-5-5H6c0 3.9 3.1 7 7 7s7-3.1 7-7c0-3.9-3.1-7-7-7z"/></svg>
                </button>
              </div>
            </div>
          </div>

          <div class="text-right">
            <div class="text-sm text-gray-500">Manual Timer</div>
          </div>
        </div>

        <div class="flex justify-between items-baseline text-lg md:text-xl pt-2">
          <span class="font-medium text-gray-600">Distance</span>
          <span id="summaryDistance" class="font-semibold text-gray-900">-- km</span>
        </div>
        <div class="flex justify-between items-baseline text-lg md:text-xl">
          <span class="font-medium text-gray-600">Avg Speed</span>
          <span id="summaryAvgSpeed" class="font-semibold text-gray-900">-- km/h</span>
        </div>
        <div class="flex justify-between items-baseline text-lg md:text-xl">
          <span class="font-medium text-gray-600">Max Speed</span>
          <span id="summaryMaxSpeed" class="font-semibold text-gray-900">-- km/h</span>
        </div>
      </div>

    </div>

    <div class="md:col-span-3 h-[40vh] md:h-full w-full" id="map"></div>

  </div>

  <div class="absolute top-4 right-4 flex flex-col md:flex-row gap-2 z-[1000]">
    <button type="button" id="connectButton" class="px-4 py-2 bg-white/70 hover:bg-white/90 border border-gray-300/50 text-blue-600 font-semibold rounded-lg shadow-lg transition duration-200 ease-in-out backdrop-blur-lg disabled:opacity-50 disabled:cursor-not-allowed">Connect</button>
    <button type="button" id="disconnectButton" class="px-4 py-2 bg-white/70 hover:bg-white/90 border border-gray-300/50 text-red-600 font-semibold rounded-lg shadow-lg transition duration-200 ease-in-out backdrop-blur-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>Disconnect</button>
    <div id="connectionStatus" class="px-4 py-2 bg-white/50 text-gray-700 font-medium rounded-lg shadow-lg backdrop-blur-lg text-center border border-white/40">Disconnected</div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    /* SMARTCYCLE HUD JAVASCRIPT - FORMATTED + TIMER ICONS + PROXIMITY + TRIP TRACING */

    const SERVICE_UUID = "12345678-1234-1234-1234-123456789abc";
    const CHARACTERISTIC_UUID = "87654321-4321-4321-4321-cba987654321";

    const FIELDS = { "Lat":{}, "Lon":{}, "Spd":{}, "Alt":{}, "Dist":{}, "Sats":{}, "AX":{}, "AY":{}, "AZ":{}, "GX":{}, "GY":{}, "GZ":{}, "Prox":{} };

    const CRASH_DETECTION_THRESHOLD = 250;
    const TERRAIN_HISTORY_LENGTH = 15;
    const TERRAIN_ROUGH_THRESHOLD = 20000000;
    const TERRAIN_MODERATE_THRESHOLD = 5000000;

    // Proximity thresholds (cm)
    const PROX_SAFE_THRESHOLD = 90; // green
    const PROX_WARNING_THRESHOLD = 50; // yellow

    const KcalPerKm = 40;

    // Path tracking
    let pathLatLngs = [];
    let pathPolyline = null;
    const PATH_MIN_DISTANCE_M = 2; // ignore small GPS jitter

    let bleDevice=null, bleServer=null, bleCharacteristic=null;
    let map=null, mapMarker=null;
    let session={startTime:null, durationInterval:null, maxSpeed:0, totalSpeed:0, speedReadings:0, totalDistanceCM:0, totalCalories:0, traveledMeters:0};
    const terrainHistory = {ax:[], ay:[], az:[]};
    const DOM = {};

    // Manual timer state
    let manualTimer = {running:false, startTs:0, elapsedBefore:0, interval:null};

    // Proximity state
    let proxState='unknown', lastProxAlertTs=0;

    // Calculation delay control: ignore initial noisy GPS for a short time after connect
    const CALC_DELAY_MS = 7000; // 7 seconds (between 5-10s as requested)
    let calcStartAt = 0;
    let calculationEnabled = false;

    window.addEventListener('DOMContentLoaded', ()=>{
      DOM.connectButton=document.getElementById('connectButton'); DOM.disconnectButton=document.getElementById('disconnectButton'); DOM.connectionStatus=document.getElementById('connectionStatus');
      DOM.speedValue=document.getElementById('speedValue'); DOM.crashPanel=document.getElementById('crashPanel'); DOM.crashStatus=document.getElementById('crashStatus'); DOM.terrainPanel=document.getElementById('terrainPanel'); DOM.terrainStatus=document.getElementById('terrainStatus');
      DOM.map=document.getElementById('map');
      DOM.summaryDuration=document.getElementById('summaryDuration'); DOM.summaryDistance=document.getElementById('summaryDistance'); DOM.summaryAvgSpeed=document.getElementById('summaryAvgSpeed'); DOM.summaryMaxSpeed=document.getElementById('summaryMaxSpeed');
      DOM.overlayCaloriesValue=document.getElementById('overlayCaloriesValue'); DOM.proxDotSmall=document.getElementById('proxDotSmall'); DOM.overlayProxValue=document.getElementById('overlayProxValue');
      DOM.timerStart=document.getElementById('timerStart'); DOM.timerStop=document.getElementById('timerStop'); DOM.timerReset=document.getElementById('timerReset');

      DOM.connectButton.addEventListener('click', onConnectButtonClick); DOM.disconnectButton.addEventListener('click', onDisconnectButtonClick);
      DOM.timerStart.addEventListener('click', ()=>startManualTimer()); DOM.timerStop.addEventListener('click', ()=>stopManualTimer()); DOM.timerReset.addEventListener('click', ()=>resetManualTimer());

      if(typeof L !== 'undefined') initializeMap(51.505, -0.09);
    });

    async function onConnectButtonClick(){ if(!navigator.bluetooth) return updateConnectionStatus('Bluetooth not supported','error'); try{ updateConnectionStatus('Requesting device...','connecting'); bleDevice=await navigator.bluetooth.requestDevice({filters:[{services:[SERVICE_UUID]}], optionalServices:[SERVICE_UUID]}); if(!bleDevice) return updateConnectionStatus('No device selected','disconnected'); updateConnectionStatus('Connecting...','connecting'); bleDevice.addEventListener('gattserverdisconnected', onGATTServerDisconnected); bleServer=await bleDevice.gatt.connect(); const service=await bleServer.getPrimaryService(SERVICE_UUID); bleCharacteristic=await service.getCharacteristic(CHARACTERISTIC_UUID); await bleCharacteristic.startNotifications(); bleCharacteristic.addEventListener('characteristicvaluechanged', handleCharacteristicNotification); updateConnectionStatus(`Connected to ${bleDevice.name||'Device'}`,'connected'); DOM.connectButton.disabled=true; DOM.disconnectButton.disabled=false; startSession();
      // set delayed calculation start time
      calcStartAt = Date.now() + CALC_DELAY_MS;
      calculationEnabled = false;
    }catch(e){ console.error(e); updateConnectionStatus('Connection failed','error'); if(bleDevice && bleDevice.gatt && bleDevice.gatt.connected) bleDevice.gatt.disconnect(); } }
    function onDisconnectButtonClick(){ if(bleDevice && bleDevice.gatt && bleDevice.gatt.connected) bleDevice.gatt.disconnect(); else onGATTServerDisconnected(); }
    function onGATTServerDisconnected(){ updateConnectionStatus('Disconnected','disconnected'); DOM.connectButton.disabled=false; DOM.disconnectButton.disabled=true; if(bleCharacteristic && typeof bleCharacteristic.removeEventListener==='function') bleCharacteristic.removeEventListener('characteristicvaluechanged', handleCharacteristicNotification); bleDevice=null; bleServer=null; bleCharacteristic=null; stopSession(); resetUI(); }

    function handleCharacteristicNotification(evt){ if(!evt.target||!evt.target.value) return; const value=new TextDecoder().decode(evt.target.value); const data=parseDataString(value); if(!data||Object.keys(data).length===0) return; const analysisData={ lat: parseFloat(data['Lat'])||null, lon: parseFloat(data['Lon'])||null, spd: parseFloat(data['Spd'])||0, alt: parseFloat(data['Alt'])||0, dist: parseFloat(data['Dist'])||0, sats: parseInt(data['Sats'])||0, ax: parseFloat(data['AX'])||0, ay: parseFloat(data['AY'])||0, az: parseFloat(data['AZ'])||0, gx: parseFloat(data['GX'])||0, gy: parseFloat(data['GY'])||0, gz: parseFloat(data['GZ'])||0, prox: (data['Prox']!==undefined)?parseFloat(data['Prox']):null };

      // Update main gauge immediately
      DOM.speedValue.textContent = analysisData.spd.toFixed(1);

      // If GPS present, decide whether to enable calculations yet
      if(analysisData.lat !== null && analysisData.lon !== null) {
        if(!calculationEnabled) {
          if(Date.now() >= calcStartAt) {
            // Enable calculations now and seed path with current location
            calculationEnabled = true;
            pathLatLngs = [[analysisData.lat, analysisData.lon]];
            session.traveledMeters = 0;
            // initialize polyline if map exists
            if(map) {
              if(pathPolyline) pathPolyline.remove();
              pathPolyline = L.polyline(pathLatLngs, { color: '#2563eb', weight: 4, opacity: 0.9, lineJoin: 'round' }).addTo(map);
            }
          } else {
            // Still in warm-up period: update marker position but DON'T accumulate distance/calories
            updateMarkerOnly(analysisData.lat, analysisData.lon);
          }
        }

        // If enabled, update path + map
        if(calculationEnabled) updateMapPositionWithPath(analysisData.lat, analysisData.lon);
      }

      // Continue running other analyses regardless of warm-up
      checkCrash(analysisData.gx, analysisData.gy, analysisData.gz);
      updateTerrainHistory(analysisData.ax, analysisData.ay, analysisData.az);
      checkTerrain();

      if(analysisData.prox !== null) checkProximity(analysisData.prox);

      // Update session stats only if calculation enabled
      if(calculationEnabled) updateSessionStats(analysisData);
    }

    function parseDataString(s){ if(!s) return null; const obj={}; s.split(',').forEach(pair=>{ const parts=pair.split(':'); if(parts.length<2) return; const key=parts[0].trim(); const val=parts.slice(1).join(':').trim(); if(key && FIELDS[key]) obj[key]=val; }); return obj; }

    function updateConnectionStatus(text,status){ DOM.connectionStatus.textContent=text; DOM.connectionStatus.classList.remove('bg-white/50','text-gray-700','bg-yellow-100/50','text-yellow-700','bg-green-100/50','text-green-700','bg-red-100/50','text-red-700'); if(status==='connecting') DOM.connectionStatus.classList.add('bg-yellow-100/50','text-yellow-700'); else if(status==='connected') DOM.connectionStatus.classList.add('bg-green-100/50','text-green-700'); else if(status==='error') DOM.connectionStatus.classList.add('bg-red-100/50','text-red-700'); else DOM.connectionStatus.classList.add('bg-white/50','text-gray-700'); }

    function initializeMap(lat,lon){ if(map) return; try{ map=L.map(DOM.map,{zoomControl:false, attributionControl:false}).setView([lat,lon],13); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'Â© OpenStreetMap contributors'}).addTo(map); const pulsingIcon=L.divIcon({className:'gps-marker-icon', html:'<div class="gps-ring"></div>', iconSize:[24,24], iconAnchor:[12,12]}); mapMarker=L.marker([lat,lon],{icon:pulsingIcon}).addTo(map);
          // init path (but don't start counting until calculationEnabled)
          pathLatLngs = [[lat,lon]];
          if(pathPolyline) pathPolyline.remove();
          pathPolyline = L.polyline(pathLatLngs, { color: '#2563eb', weight: 4, opacity: 0.9, lineJoin: 'round' }).addTo(map);
        }catch(e){ console.error('Map init failed', e);} }

    function updateMarkerOnly(lat, lon){ // update marker & view but do not add to path or compute distance
      if(!map || !mapMarker){ initializeMap(lat,lon); if(!map) return; }
      const newLatLng = [lat,lon];
      mapMarker.setLatLng(newLatLng);
      map.setView(newLatLng, 17, { animate: true, pan: { duration: 0.5 } });
    }

    function updateMapPositionWithPath(lat,lon){ if(!map || !mapMarker){ initializeMap(lat,lon); if(!map) return; } const newLatLng = [lat,lon]; mapMarker.setLatLng(newLatLng);
      // add to path if moved enough
      const last = pathLatLngs.length ? pathLatLngs[pathLatLngs.length-1] : null;
      let shouldAdd = true;
      if(last){ const d = distanceMeters(last[0], last[1], lat, lon); if(d < PATH_MIN_DISTANCE_M) shouldAdd = false; }
      if(shouldAdd){ pathLatLngs.push(newLatLng); if(pathPolyline) pathPolyline.setLatLngs(pathLatLngs); else pathPolyline = L.polyline(pathLatLngs, { color: '#2563eb', weight: 4, opacity: 0.9, lineJoin: 'round' }).addTo(map);
        // update traveled distance (meters)
        if(last){ const d = distanceMeters(last[0], last[1], lat, lon); session.traveledMeters += d; session.totalDistanceCM = Math.round(session.traveledMeters * 100);
          DOM.summaryDistance.textContent = `${(session.traveledMeters/1000).toFixed(2)} km`; }
      }
      // keep HUD centered
      map.setView(newLatLng, 17, { animate: true, pan: { duration: 0.5 } }); }

    // haversine
    function distanceMeters(lat1, lon1, lat2, lon2){ const toRad = x => x * Math.PI / 180; const R = 6371000; const dLat = toRad(lat2-lat1); const dLon = toRad(lon2-lon1); const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2); const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R * c; }

    let crashDetected=false; function checkCrash(gx,gy,gz){ const isCrash=Math.abs(gx)>CRASH_DETECTION_THRESHOLD||Math.abs(gy)>CRASH_DETECTION_THRESHOLD||Math.abs(gz)>CRASH_DETECTION_THRESHOLD; if(isCrash && !crashDetected){ crashDetected=true; DOM.crashStatus.textContent='CRASH!'; DOM.crashPanel.classList.remove('bg-green-500/10','border-green-500/30'); DOM.crashPanel.classList.add('bg-red-500/10','border-red-500/30'); let emergencyOverlay=document.getElementById('emergencyOverlay'); if(!emergencyOverlay){ emergencyOverlay=document.createElement('div'); emergencyOverlay.id='emergencyOverlay'; emergencyOverlay.innerHTML=`<h1 class="text-5xl md:text-7xl font-black mb-8 animate-pulse">CRASH DETECTED!</h1><p class="text-2xl md:text-3xl mb-12">Are you okay?</p><button id="callEmergency" class="px-8 py-4 bg-white/90 text-red-700 hover:bg-white text-3xl font-bold rounded-full shadow-xl transition duration-300 transform hover:scale-105 mb-6">Call Emergency Services</button><button id="dismissEmergency" class="px-6 py-3 bg-white/50 text-gray-900 hover:bg-white/70 text-xl font-semibold rounded-full shadow-md transition duration-300">Dismiss</button>`; document.body.appendChild(emergencyOverlay); document.getElementById('callEmergency').addEventListener('click',()=>{ console.log('Calling emergency services...'); dismissEmergencyOverlay(); }); document.getElementById('dismissEmergency').addEventListener('click',()=>{ dismissEmergencyOverlay(); }); } } else if(!isCrash && !crashDetected){ DOM.crashStatus.textContent='SAFE'; DOM.crashPanel.classList.remove('bg-red-500/10','border-red-500/30'); DOM.crashPanel.classList.add('bg-green-500/10','border-green-500/30'); } }
    function dismissEmergencyOverlay(){ const overlay=document.getElementById('emergencyOverlay'); if(overlay){ document.getElementById('callEmergency')?.removeEventListener('click', dismissEmergencyOverlay); document.getElementById('dismissEmergency')?.removeEventListener('click', dismissEmergencyOverlay); overlay.remove(); crashDetected=false; document.body.classList.remove('bg-red-500'); document.body.classList.add('bg-gradient-to-br','from-blue-100','via-gray-100','to-blue-200'); DOM.crashStatus.textContent='SAFE'; DOM.crashPanel.classList.remove('bg-red-500/10','border-red-500/30'); DOM.crashPanel.classList.add('bg-green-500/10','border-green-500/30'); } }

    function updateTerrainHistory(ax,ay,az){ terrainHistory.ax.push(ax); terrainHistory.ay.push(ay); terrainHistory.az.push(az); if(terrainHistory.ax.length>TERRAIN_HISTORY_LENGTH) terrainHistory.ax.shift(); if(terrainHistory.ay.length>TERRAIN_HISTORY_LENGTH) terrainHistory.ay.shift(); if(terrainHistory.az.length>TERRAIN_HISTORY_LENGTH) terrainHistory.az.shift(); }
    function calculateVariance(arr){ if(!arr||arr.length<2) return 0; const mean=arr.reduce((a,b)=>a+b,0)/arr.length; return arr.reduce((acc,val)=>acc+Math.pow(val-mean,2),0)/arr.length; }
    function checkTerrain(){ if(terrainHistory.ax.length<TERRAIN_HISTORY_LENGTH) return; const varAX=calculateVariance(terrainHistory.ax); const varAY=calculateVariance(terrainHistory.ay); const varAZ=calculateVariance(terrainHistory.az); const totalVariance=varAX+varAY+varAZ; DOM.terrainPanel.classList.remove('bg-green-500/10','border-green-500/30','bg-yellow-500/10','border-yellow-500/30','bg-red-500/10','border-red-500/30'); if(totalVariance>TERRAIN_ROUGH_THRESHOLD){ DOM.terrainStatus.textContent='ROUGH'; DOM.terrainPanel.classList.add('bg-red-500/10','border-red-500/30'); } else if(totalVariance>TERRAIN_MODERATE_THRESHOLD){ DOM.terrainStatus.textContent='MODERATE'; DOM.terrainPanel.classList.add('bg-yellow-500/10','border-yellow-500/30'); } else { DOM.terrainStatus.textContent='SMOOTH'; DOM.terrainPanel.classList.add('bg-green-500/10','border-green-500/30'); } }

    // PROXIMITY
    function checkProximity(distanceCM){ if(distanceCM===null||isNaN(distanceCM)) return; let newState='green'; if(distanceCM>=PROX_SAFE_THRESHOLD) newState='green'; else if(distanceCM>=PROX_WARNING_THRESHOLD) newState='yellow'; else newState='red'; if(DOM.overlayProxValue) DOM.overlayProxValue.textContent = Math.round(distanceCM); if(DOM.proxDotSmall){ DOM.proxDotSmall.classList.remove('prox-green','prox-yellow','prox-red','prox-pulse'); if(newState==='green'){ DOM.proxDotSmall.classList.add('prox-green'); } else if(newState==='yellow'){ DOM.proxDotSmall.classList.add('prox-yellow'); } else { DOM.proxDotSmall.classList.add('prox-red','prox-pulse'); } } const now=Date.now(); if(newState==='red' && proxState!=='red' && (now-lastProxAlertTs)>3000){ playBeep(); lastProxAlertTs=now; } proxState=newState; }
    function playBeep(){ try{ const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine'; o.frequency.value=700; g.gain.value=0.04; o.connect(g); g.connect(ctx.destination); o.start(); setTimeout(()=>{ o.stop(); ctx.close(); },220); }catch(e){console.warn('Beep failed',e);} }

    // SESSION & MANUAL TIMER
    function startSession(){ stopSession(); session.startTime=Date.now(); session.maxSpeed=0; session.totalSpeed=0; session.speedReadings=0; session.totalDistanceCM=0; session.totalCalories=0; session.traveledMeters=0; session.durationInterval=setInterval(()=>{/* reserved */},1000); }
    function stopSession(){ if(session.durationInterval){ clearInterval(session.durationInterval); session.durationInterval=null; } }

    function startManualTimer(){ if(manualTimer.running) return; manualTimer.running=true; manualTimer.startTs=Date.now(); manualTimer.interval=setInterval(()=>{ updateManualTimerDisplay(); },250); }
    function stopManualTimer(){ if(!manualTimer.running) return; manualTimer.running=false; clearInterval(manualTimer.interval); manualTimer.interval=null; manualTimer.elapsedBefore += Date.now() - manualTimer.startTs; updateManualTimerDisplay(); }
    function resetManualTimer(){ manualTimer.running=false; clearInterval(manualTimer.interval); manualTimer.interval=null; manualTimer.startTs=0; manualTimer.elapsedBefore=0; updateManualTimerDisplay(); }
    function updateManualTimerDisplay(){ const elapsed = manualTimer.elapsedBefore + (manualTimer.running ? (Date.now() - manualTimer.startTs) : 0); const totalSeconds=Math.floor(elapsed/1000); const hours=Math.floor(totalSeconds/3600); const minutes=Math.floor((totalSeconds%3600)/60); const seconds=totalSeconds%60; DOM.summaryDuration.textContent = [hours.toString().padStart(2,'0'), minutes.toString().padStart(2,'0'), seconds.toString().padStart(2,'0')].join(':'); }

    function updateSessionStats(data){ if(!calculationEnabled) return; if(data.spd>session.maxSpeed){ session.maxSpeed=data.spd; DOM.summaryMaxSpeed.textContent = `${session.maxSpeed.toFixed(1)} km/h`; } session.totalSpeed += data.spd; session.speedReadings++; const avgSpeed = session.speedReadings>0 ? session.totalSpeed/session.speedReadings : 0; DOM.summaryAvgSpeed.textContent = `${avgSpeed.toFixed(1)} km/h`; // if device sends Dist we still prioritize computed traveledMeters for the map
      if(session.traveledMeters>0){ DOM.summaryDistance.textContent = `${(session.traveledMeters/1000).toFixed(2)} km`; session.totalDistanceCM = Math.round(session.traveledMeters*100); } else { session.totalDistanceCM = data.dist; const distKm = (session.totalDistanceCM/100/1000); DOM.summaryDistance.textContent = `${distKm.toFixed(2)} km`; }
      session.totalCalories = (session.traveledMeters/1000) * KcalPerKm; const calValue = Math.round(session.totalCalories); if(DOM.overlayCaloriesValue) DOM.overlayCaloriesValue.textContent = isFinite(calValue)?calValue:'--'; }

    function resetUI(){ dismissEmergencyOverlay(); DOM.speedValue.textContent='--'; DOM.crashStatus.textContent='SAFE'; DOM.crashPanel.className='bg-white/30 backdrop-blur-lg rounded-2xl p-4 text-center transition-all duration-300 shadow-md border-2 border-green-500/30 bg-green-500/10'; DOM.terrainStatus.textContent='SMOOTH'; DOM.terrainPanel.className='bg-white/30 backdrop-blur-lg rounded-2xl p-4 text-center transition-all duration-300 shadow-md border-2 border-green-500/30 bg-green-500/10'; DOM.summaryDuration.textContent='--:--:--'; DOM.summaryDistance.textContent='-- km'; DOM.summaryAvgSpeed.textContent='-- km/h'; DOM.summaryMaxSpeed.textContent='-- km/h'; if(DOM.overlayCaloriesValue) DOM.overlayCaloriesValue.textContent='--'; if(DOM.overlayProxValue) DOM.overlayProxValue.textContent='--'; if(DOM.proxDotSmall) { DOM.proxDotSmall.className='prox-dot prox-green'; }
      // reset manual timer
      resetManualTimer();
      // reset path
      if(pathPolyline){ pathPolyline.remove(); pathPolyline = null; }
      pathLatLngs = [];
      session.traveledMeters = 0;
      calculationEnabled = false;
    }

  </script>
</body>
</html>
